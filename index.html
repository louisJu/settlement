<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì •ì‚° ê³„ì‚°ê¸°</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div id="start-screen" class="max-w-4xl mx-auto space-y-6">
    <div class="bg-white p-6 rounded-2xl shadow-md text-center">
      <h1 class="text-2xl font-bold mb-4">ğŸš€ ì •ì‚° ê³„ì‚°ê¸°</h1>
      <p class="text-gray-600 mb-6">ìƒˆë¡œìš´ ì •ì‚°ì„ ì‹œì‘í•˜ê±°ë‚˜ ê¸°ì¡´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>

      <button id="custom-install-btn" class="hidden w-full px-4 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition mb-3">
        ğŸ“² ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°
      </button>

      <button onclick="createNewSettlement()" class="w-full px-4 py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition">
        ìƒˆë¡œìš´ ì •ì‚° ì‘ì„±í•˜ê¸°
      </button>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">ì €ì¥ëœ ì •ì‚° ëª©ë¡</h2>
      <div id="saved-settlements-list" class="space-y-3"></div>
    </div>
  </div>

  <div id="main-app" class="max-w-4xl mx-auto space-y-6 hidden">
    <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between">
       <button onclick="showStartScreen()" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-xl hover:bg-gray-300 transition">&lt; ëª©ë¡ìœ¼ë¡œ</button>
       <h1 id="settlement-title" class="text-xl font-bold text-center flex-1">ì •ì‚°</h1>
       <div class="w-24"></div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">ì°¸ì—¬ì ê´€ë¦¬</h2>
        <button onclick="resetAllData()" class="px-3 py-1 bg-red-500 text-white text-sm rounded-xl hover:bg-red-600 transition">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
      <div class="flex gap-2 mb-3">
        <input id="personName" type="text" placeholder="ì´ë¦„ ì…ë ¥"
          class="flex-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
        <button onclick="addPerson()"
          class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition">ì¶”ê°€</button>
      </div>
      <div id="personList" class="flex flex-wrap gap-2"></div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">ì§€ì¶œ ì¶”ê°€</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="expenseTitle" type="text" placeholder="í•­ëª©" class="rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
        <input id="expenseAmount" type="number" placeholder="ê¸ˆì•¡" class="rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
        <select id="paidBy" class="rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition">
          <option value="">ê²°ì œì ì„ íƒ</option>
        </select>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="splitType" value="equal" checked onchange="toggleSplitType()"><span>ê· ë“± ë¶„í• </span></label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="splitType" value="manual" onchange="toggleSplitType()"><span>ìˆ˜ë™ ì…ë ¥</span></label>
        </div>
      </div>
      <div id="equalSplitContainer" class="mt-3">
        <span class="font-semibold">ì •ì‚° ëŒ€ìƒì:</span>
        <div id="involvedPeopleContainer" class="flex flex-wrap gap-2 mt-2"></div>
      </div>
      <div id="manualSplitContainer" class="mt-3 hidden">
        <span class="font-semibold">ê°œë³„ ì •ì‚° ê¸ˆì•¡:</span>
        <div id="manualAmountContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2"></div>
        <div id="amountValidation" class="mt-2 text-sm"></div>
      </div>
      <div class="mt-3">
        <label class="block text-sm font-medium mb-1">ë¹„ê³  (ì„ íƒì‚¬í•­):</label>
        <input id="expenseNote" type="text" placeholder="ë¹„ê³  ì…ë ¥" class="w-full rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
      </div>
      <button onclick="addExpense()" class="mt-4 px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 w-full transition">ì§€ì¶œ ì¶”ê°€</button>
    </div>

    <div id="expense-list-card" class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">ì§€ì¶œ ëª©ë¡</h2>
      <div id="expenseList" class="space-y-3"></div>
    </div>

    <div id="summary-card" class="bg-white p-6 rounded-2xl shadow-md space-y-6">
      <div id="summary-menu" class="flex justify-between items-center flex-wrap gap-2">
        <h2 class="text-lg font-semibold mb-4">ì •ì‚° ê²°ê³¼ ğŸš€</h2>
        <div class="flex gap-2">
          <select id="roundingOption" onchange="updateSummary()" class="px-3 py-1 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 transition">
            <option value="none">ì›ë‹¨ìœ„ ê·¸ëŒ€ë¡œ</option>
            <option value="0">ì†Œìˆ˜ì  ì œê±°</option>
            <option value="10">1ì› ë‹¨ìœ„ ë°˜ì˜¬ë¦¼</option>
            <option value="100">10ì› ë‹¨ìœ„ ë°˜ì˜¬ë¦¼</option>
          </select>
          <button onclick="exportTXT()" class="px-3 py-1 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-sm transition">TXT</button>
          <button id="pdf-export-btn" onclick="exportPDF()" class="px-3 py-1 bg-purple-500 text-white rounded-xl hover:bg-purple-600 text-sm transition">PDF</button>
        </div>
      </div>

      <div id="total-spending" class="p-4 bg-gray-100 rounded-xl text-center">
         <p class="text-gray-600">ì´ ì§€ì¶œ ê¸ˆì•¡</p>
         <p id="totalAmount" class="text-2xl font-bold text-gray-800">â‚© 0</p>
      </div>

      <div>
        <h3 class="font-bold mb-3 text-lg">ğŸ’¸ ê°œì¸ë³„ ì •ì‚° í˜„í™©</h3>
        <div id="summaryList" class="space-y-2"></div>
      </div>

      <div class="border-t pt-4">
        <h3 class="font-bold mb-3 text-lg">âœ… ì •ì‚° ë°©ë²•</h3>
        <div id="transactionList" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <div id="install-popup-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 transition-opacity">
    <div id="install-popup-content" class="bg-white rounded-2xl shadow-xl p-6 m-4 max-w-sm w-full text-center transform scale-95 transition-transform">
      <h3 class="text-xl font-bold mb-2">ì•±ì²˜ëŸ¼ ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”!</h3>
      <p class="text-gray-600 mb-4">ë°”íƒ•í™”ë©´ì— 'ì •ì‚° ê³„ì‚°ê¸°'ë¥¼ ì¶”ê°€í•˜ê³ <br>ë” ë¹ ë¥´ê³  í¸ë¦¬í•˜ê²Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div id="install-guide" class="bg-gray-100 p-4 rounded-lg mb-4">
        <div id="install-guide-icon" class="w-12 h-12 mx-auto mb-2 text-blue-500"></div>
        <p id="install-guide-text" class="font-semibold text-gray-700"></p>
      </div>
      <div class="flex flex-col gap-2">
        <button id="close-popup-btn" class="w-full px-4 py-2 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition">ì´í•´í–ˆìŠµë‹ˆë‹¤</button>
        <button id="dismiss-popup-btn" class="w-full text-sm text-gray-500 hover:text-gray-700">ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°</button>
      </div>
    </div>
  </div>

<script>
    // --- ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ---
    let people = [];
    let expenses = [];
    let currentSettlementId = null;

    // --- ë°ì´í„° ê´€ë¦¬ ë° ì•± í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
    function getSettlements() {
      return JSON.parse(localStorage.getItem('settlements') || '[]');
    }

    function saveSettlements(settlements) {
      localStorage.setItem('settlements', JSON.stringify(settlements));
    }

    function saveCurrentSettlement() {
        if (!currentSettlementId) return;
        const settlements = getSettlements();
        const index = settlements.findIndex(s => s.id === currentSettlementId);
        if (index > -1) {
            settlements[index].people = people;
            settlements[index].expenses = expenses;
            saveSettlements(settlements);
        }
    }

    function showStartScreen() {
        document.getElementById('start-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
        renderSavedSettlements();
        currentSettlementId = null;
    }

    function showMainApp() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function renderSavedSettlements() {
        const settlements = getSettlements();
        const container = document.getElementById('saved-settlements-list');
        container.innerHTML = '';
        if (settlements.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500">ì €ì¥ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            return;
        }
        settlements.sort((a, b) => b.id - a.id);
        settlements.forEach(s => {
            const date = new Date(s.id).toLocaleDateString('ko-KR');
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-xl';
            div.innerHTML = `
                <div>
                    <p class="font-semibold">${s.name}</p>
                    <p class="text-sm text-gray-500">ìƒì„±ì¼: ${date}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadSettlement(${s.id})" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-xl hover:bg-blue-600 transition">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button onclick="deleteSettlement(${s.id})" class="px-3 py-1 bg-red-500 text-white text-sm rounded-xl hover:bg-red-600 transition">ì‚­ì œ</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function createNewSettlement() {
        const name = prompt("ìƒˆë¡œìš´ ì •ì‚°ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:", `ì •ì‚° ${new Date().toLocaleDateString()}`);
        if (!name || !name.trim()) return;
        const settlements = getSettlements();
        const newSettlement = {
            id: Date.now(),
            name: name.trim(),
            people: [],
            expenses: []
        };
        settlements.push(newSettlement);
        saveSettlements(settlements);
        loadSettlement(newSettlement.id);
    }

    function loadSettlement(id) {
        const settlements = getSettlements();
        const settlement = settlements.find(s => s.id === id);
        if (settlement) {
            currentSettlementId = settlement.id;
            people = settlement.people || [];
            expenses = settlement.expenses || [];
            document.getElementById('settlement-title').innerText = settlement.name;
            showMainApp();
            renderAll();
        }
    }

    function deleteSettlement(id) {
        if (!confirm("ì •ë§ë¡œ ì´ ì •ì‚° ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        let settlements = getSettlements();
        settlements = settlements.filter(s => s.id !== id);
        saveSettlements(settlements);
        renderSavedSettlements();
    }

    function initializeApp() {
        showStartScreen();
    }

    function renderAll() {
        renderPeople();
        renderExpenses();
        updateSummary();
    }

    function resetAllData() {
        if(confirm('ì •ë§ë¡œ ëª¨ë“  ì°¸ì—¬ìì™€ ì§€ì¶œ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            people = [];
            expenses = [];
            saveCurrentSettlement();
            renderAll();
        }
    }

    function renderPeople() {
        const personList = document.getElementById("personList");
        const paidBy = document.getElementById("paidBy");
        const involvedContainer = document.getElementById("involvedPeopleContainer");
        const manualContainer = document.getElementById("manualAmountContainer");
        personList.innerHTML = "";
        paidBy.innerHTML = '<option value="">ê²°ì œì ì„ íƒ</option>';
        involvedContainer.innerHTML = "";
        manualContainer.innerHTML = "";
        people.forEach((person, index) => {
            const badge = document.createElement("div");
            badge.className = "flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full";
            badge.innerHTML = `<span>${person}</span><button onclick="removePerson(${index})" class="text-red-500 hover:text-red-700 font-bold">x</button>`;
            personList.appendChild(badge);
            const opt1 = new Option(person, person);
            paidBy.add(opt1);
            const checkbox = document.createElement("label");
            checkbox.className = "flex items-center gap-2 px-3 py-1 bg-gray-200 rounded-xl cursor-pointer text-gray-700";
            checkbox.innerHTML = `<input type="checkbox" class="involved-checkbox" value="${person}" checked> ${person}`;
            involvedContainer.appendChild(checkbox);
            const manualInput = document.createElement("div");
            manualInput.className = "flex items-center gap-2";
            manualInput.innerHTML = `<label class="w-20 text-sm font-medium">${person}:</label><input type="number" class="manual-amount flex-1 rounded-xl border px-2 py-1" data-person="${person}" placeholder="0" oninput="validateManualAmounts()"><span class="text-xs text-gray-500">ì›</span>`;
            manualContainer.appendChild(manualInput);
        });
    }

    function addPerson() {
      const input = document.getElementById("personName");
      const name = input.value.trim();
      if (!name) return;
      if (people.includes(name)) {
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
        return;
      }
      people.push(name);
      input.value = "";
      renderPeople();
      updateSummary();
      saveCurrentSettlement();
    }

    function removePerson(index) {
      people.splice(index, 1);
      renderPeople();
      updateSummary();
      saveCurrentSettlement();
    }

    function toggleSplitType() {
      const isManual = document.querySelector('input[name="splitType"]:checked').value === 'manual';
      document.getElementById('equalSplitContainer').classList.toggle('hidden', isManual);
      document.getElementById('manualSplitContainer').classList.toggle('hidden', !isManual);
    }

    function validateManualAmounts() {
      const totalAmount = parseFloat(document.getElementById("expenseAmount").value) || 0;
      let manualTotal = 0;
      document.querySelectorAll(".manual-amount").forEach(input => {
        manualTotal += parseFloat(input.value) || 0;
      });
      const validationDiv = document.getElementById("amountValidation");
      const difference = totalAmount - manualTotal;
      if (Math.abs(difference) < 0.01) {
        validationDiv.innerHTML = '<span class="text-green-600">âœ“ ê¸ˆì•¡ì´ ì¼ì¹˜í•©ë‹ˆë‹¤</span>';
      } else if (difference > 0) {
        validationDiv.innerHTML = `<span class="text-orange-600">âš  ${difference.toLocaleString()}ì› ë¶€ì¡±í•©ë‹ˆë‹¤</span>`;
      } else {
        validationDiv.innerHTML = `<span class="text-red-600">âœ— ${Math.abs(difference).toLocaleString()}ì› ì´ˆê³¼ì…ë‹ˆë‹¤</span>`;
      }
    }

    function addExpense() {
      const title = document.getElementById("expenseTitle").value.trim();
      const amount = parseFloat(document.getElementById("expenseAmount").value);
      const paidBy = document.getElementById("paidBy").value;
      const splitType = document.querySelector('input[name="splitType"]:checked').value;
      if (!title || isNaN(amount) || amount <= 0 || !paidBy) {
        alert("í•­ëª©, 0ì› ì´ˆê³¼ì˜ ê¸ˆì•¡, ê²°ì œìë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      const expenseData = { title, amount, paidBy, splitType };
      if (splitType === 'equal') {
        const involved = Array.from(document.querySelectorAll(".involved-checkbox:checked")).map(cb => cb.value);
        if (involved.length === 0) {
          alert("ì •ì‚° ëŒ€ìƒìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        expenseData.involved = involved;
      } else {
        const manualAmounts = {};
        let manualTotal = 0;
        document.querySelectorAll(".manual-amount").forEach(input => {
          const personAmount = parseFloat(input.value) || 0;
          if (personAmount > 0) {
            manualAmounts[input.dataset.person] = personAmount;
            manualTotal += personAmount;
          }
        });
        if (Math.abs(amount - manualTotal) > 0.01) {
          alert("ìˆ˜ë™ ì…ë ¥ ê¸ˆì•¡ì˜ í•©ì´ ì´ ê¸ˆì•¡ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
        if (Object.keys(manualAmounts).length === 0) {
          alert("ìµœì†Œ í•œ ëª…ì˜ ì •ì‚° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        expenseData.manualAmounts = manualAmounts;
      }
      const note = document.getElementById("expenseNote").value.trim();
      if (note) expenseData.note = note;
      expenses.push(expenseData);
      document.getElementById("expenseTitle").value = "";
      document.getElementById("expenseAmount").value = "";
      document.getElementById("paidBy").value = "";
      document.querySelectorAll(".involved-checkbox").forEach(cb => cb.checked = true);
      document.querySelectorAll(".manual-amount").forEach(input => input.value = "");
      document.getElementById("expenseNote").value = "";
      document.getElementById("amountValidation").innerHTML = "";
      renderExpenses();
      updateSummary();
      saveCurrentSettlement();
    }

    function renderExpenses() {
      const container = document.getElementById("expenseList");
      container.innerHTML = "";
      if (expenses.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500">ì¶”ê°€ëœ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        return;
      }
      expenses.forEach((exp, index) => {
        const colors = ["bg-purple-50 border-purple-200", "bg-green-50 border-green-200", "bg-yellow-50 border-yellow-200", "bg-pink-50 border-pink-200", "bg-blue-50 border-blue-200"];
        const div = document.createElement("div");
        div.className = `p-4 rounded-2xl border-2 flex justify-between items-center ${colors[index % colors.length]}`;
        let splitInfo = "";
        if (exp.splitType === 'equal') {
          splitInfo = `ì •ì‚° ëŒ€ìƒ: ${exp.involved.join(", ")}`;
        } else {
          const amounts = Object.entries(exp.manualAmounts).map(([p, a]) => `${p}: ${a.toLocaleString()}ì›`).join(", ");
          splitInfo = `ì •ì‚° ê¸ˆì•¡: ${amounts}`;
        }
        if (exp.note) splitInfo += `<br><span class="text-xs text-gray-500">ë¹„ê³ : ${exp.note}</span>`;
        const splitTypeLabel = exp.splitType === 'equal' ? 'ê· ë“±ì •ì‚°' : 'ìˆ˜ë™ì •ì‚°';
        const splitTypeBadgeColor = exp.splitType === 'equal' ? 'bg-blue-500' : 'bg-green-500';
        div.innerHTML = `<div class="flex-1"><div class="flex justify-between items-start mb-2"><span class="font-semibold">${exp.title}</span><span class="px-2 py-1 text-xs text-white rounded-full ${splitTypeBadgeColor}">${splitTypeLabel}</span></div><div class="font-bold">${exp.amount.toLocaleString()}ì› <span class="text-sm font-medium text-gray-600">(ê²°ì œì: ${exp.paidBy})</span></div><div class="text-sm text-gray-600 mt-1">${splitInfo}</div></div><button onclick="removeExpense(${index})" class="px-3 py-1 bg-red-500 text-white rounded-xl hover:bg-red-600 ml-3 transition">ì‚­ì œ</button>`;
        container.appendChild(div);
      });
    }

    function removeExpense(index) {
      expenses.splice(index, 1);
      renderExpenses();
      updateSummary();
      saveCurrentSettlement();
    }

    function updateSummary() {
      const balances = getBalances();
      const summaryList = document.getElementById("summaryList");
      summaryList.innerHTML = "";
      if (people.length === 0) {
        summaryList.innerHTML = `<p class="text-center text-gray-500 font-medium text-base">ì°¸ì—¬ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>`;
        document.getElementById('totalAmount').innerText = 'â‚© 0';
        document.getElementById('transactionList').innerHTML = '';
        return;
      }
      const totalSpending = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      document.getElementById('totalAmount').innerText = `â‚© ${totalSpending.toLocaleString()}`;
      people.forEach(person => {
        const li = document.createElement("div");
        li.className = "flex justify-between items-center p-3 rounded-xl";
        const amount = balances[person] || 0;
        let amountText;
        if (amount > 0.01) {
            li.className += ' bg-blue-50';
            amountText = `<span class="font-bold text-blue-700">+${amount.toLocaleString()}ì›</span>`;
        } else if (amount < -0.01) {
            li.className += ' bg-red-50';
            amountText = `<span class="font-bold text-red-700">${amount.toLocaleString()}ì›</span>`;
        } else {
            li.className += ' bg-gray-100';
            amountText = `<span class="font-bold text-gray-700">${amount.toLocaleString()}ì›</span>`;
        }
        li.innerHTML = `<span class="font-medium">${person}</span> ${amountText}`;
        summaryList.appendChild(li);
      });
      renderTransactions(balances);
    }

    function renderTransactions(balances) {
        const transactionList = document.getElementById("transactionList");
        transactionList.innerHTML = '';
        const transactions = calculateTransactions(balances);
        if (transactions.length === 0) {
            transactionList.innerHTML = `<p class="text-center text-green-600 font-semibold p-4 bg-green-50 rounded-xl">ëª¨ë“  ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰</p>`;
            return;
        }
        transactions.forEach(({ from, to, amount }) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-xl';
            div.innerHTML = `<span class="font-bold text-red-600">${from}</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg><span class="font-bold text-green-600">${to}</span><span class="font-semibold text-gray-800 bg-gray-200 px-3 py-1 rounded-full">${amount.toLocaleString()}ì›</span>`;
            transactionList.appendChild(div);
        });
    }

    function calculateTransactions(balances) {
        const creditors = [];
        const debtors = [];
        Object.entries(balances).forEach(([person, amount]) => {
            if (amount > 0.01) creditors.push({ person, amount });
            else if (amount < -0.01) debtors.push({ person, amount: -amount });
        });
        creditors.sort((a, b) => b.amount - a.amount);
        debtors.sort((a, b) => b.amount - a.amount);
        const transactions = [];
        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
            const debtor = debtors[i];
            const creditor = creditors[j];
            const amountToTransfer = Math.min(debtor.amount, creditor.amount);
            if (amountToTransfer > 0.01) {
              transactions.push({ from: debtor.person, to: creditor.person, amount: Math.round(amountToTransfer) });
            }
            debtor.amount -= amountToTransfer;
            creditor.amount -= amountToTransfer;
            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }
        return transactions;
    }

    function getBalances() {
      const balances = {};
      people.forEach(p => balances[p] = 0);
      expenses.forEach(exp => {
        if (people.includes(exp.paidBy)) balances[exp.paidBy] += exp.amount;
        if (exp.splitType === 'equal') {
          const share = exp.amount / exp.involved.length;
          exp.involved.forEach(p => { if (people.includes(p)) balances[p] -= share; });
        } else {
          Object.entries(exp.manualAmounts).forEach(([p, a]) => { if (people.includes(p)) balances[p] -= a; });
        }
      });
      const roundingOption = document.getElementById("roundingOption").value;
      Object.keys(balances).forEach(person => {
        const amount = balances[person];
        if (roundingOption === "0") balances[person] = Math.round(amount);
        else if (roundingOption === "10") balances[person] = Math.round(amount / 10) * 10;
        else if (roundingOption === "100") balances[person] = Math.round(amount / 100) * 100;
        else balances[person] = Math.round(amount * 100) / 100;
      });
      return balances;
    }

    function generateContent() {
      const balances = getBalances();
      const transactions = calculateTransactions(balances);
      const totalSpending = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      const now = new Date();
      let content = [ `ì •ì‚° ë‚´ì—­ (${now.toLocaleDateString('ko-KR')})`, '='.repeat(50), `ğŸ‘¥ ì°¸ì—¬ì: ${people.join(', ')}`, `ğŸ’° ì´ ì§€ì¶œ: ${totalSpending.toLocaleString()}ì›`, '', '--- ğŸ“ ì§€ì¶œ ëª©ë¡ ---' ];
      expenses.forEach((exp, index) => {
        content.push(`${index + 1}. ${exp.title} - ${exp.amount.toLocaleString()}ì› (ê²°ì œ: ${exp.paidBy})`);
        if (exp.splitType === 'equal') {
          const share = exp.amount / exp.involved.length;
          content.push(`  - ë°©ì‹: ê· ë“±ë¶„í•  (${exp.involved.join(', ')})`, `  - ì¸ë‹¹: ${Math.round(share).toLocaleString()}ì›`);
        } else {
          content.push(`  - ë°©ì‹: ìˆ˜ë™ë¶„í• `);
          Object.entries(exp.manualAmounts).forEach(([p, a]) => content.push(`    - ${p}: ${a.toLocaleString()}ì›`));
          if (exp.note) content.push(`  - ë¹„ê³ : ${exp.note}`);
        }
        content.push('');
      });
      content.push('--- ğŸ’¸ ê°œì¸ë³„ ì •ì‚° í˜„í™© ---');
      people.forEach(person => {
        const amount = balances[person] || 0;
        const status = amount > 0.01 ? 'ë°›ì„ ê¸ˆì•¡' : amount < -0.01 ? 'ë³´ë‚¼ ê¸ˆì•¡' : 'ì •ì‚°ì™„ë£Œ';
        content.push(`${person}: ${amount > 0 ? '+' : ''}${amount.toLocaleString()}ì› (${status})`);
      });
      content.push('\n--- âœ… ì •ì‚° ë°©ë²• ---');
      if (transactions.length === 0) {
        content.push('ëª¨ë“  ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      } else {
        transactions.forEach(t => { content.push(`${t.from} â†’ ${t.to} : ${t.amount.toLocaleString()}ì›`); });
      }
      return content.join('\n');
    }

    function exportTXT() {
      const content = generateContent();
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ì •ì‚°ë‚´ì—­_${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function exportPDF() {
        const exportBtn = document.getElementById('pdf-export-btn');
        const originalText = exportBtn.innerText;
        exportBtn.innerText = 'ìƒì„± ì¤‘..';
        exportBtn.disabled = true;
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const margin = 15;
            const pdfWidth = doc.internal.pageSize.getWidth() - margin * 2;
            const pageHeight = doc.internal.pageSize.getHeight();
            let currentY = margin;
            const checkPageBreak = (requiredHeight) => { if (currentY + requiredHeight > pageHeight - margin - 10) { doc.addPage(); currentY = margin; return true; } return false; };
            const addElementToPDF = async (element) => {
                if (!element || element.offsetHeight === 0) return;
                const canvas = await html2canvas(element, { scale: 1.5, useCORS: true, backgroundColor: '#ffffff', logging: false });
                const imgData = canvas.toDataURL('image/png');
                const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                const maxHeight = pageHeight - margin * 2;
                if (imgHeight > maxHeight) {
                    const totalParts = Math.ceil(imgHeight / maxHeight);
                    const partHeight = maxHeight;
                    const canvasPartHeight = canvas.height / totalParts;
                    for (let i = 0; i < totalParts; i++) {
                        if (i > 0) { doc.addPage(); currentY = margin; } else { checkPageBreak(partHeight); }
                        const partCanvas = document.createElement('canvas');
                        const partCtx = partCanvas.getContext('2d');
                        partCanvas.width = canvas.width;
                        partCanvas.height = canvasPartHeight;
                        partCtx.drawImage(canvas, 0, i * canvasPartHeight, canvas.width, canvasPartHeight, 0, 0, canvas.width, canvasPartHeight);
                        const partImgData = partCanvas.toDataURL('image/png');
                        doc.addImage(partImgData, 'PNG', margin, currentY, pdfWidth, partHeight);
                        currentY += partHeight + 3;
                    }
                } else {
                    checkPageBreak(imgHeight);
                    doc.addImage(imgData, 'PNG', margin, currentY, pdfWidth, imgHeight);
                    currentY += imgHeight + 5;
                }
            };
            const printContainer = document.createElement('div');
            printContainer.style.cssText = `position: fixed; top: 0; left: 0; width: 750px; background: white; padding: 20px; z-index: -9999; opacity: 0;`;
            const expenseCard = document.getElementById('expense-list-card').cloneNode(true);
            const summaryCard = document.getElementById('summary-card').cloneNode(true);
            summaryCard.querySelectorAll('button, select').forEach(btn => btn.remove());
            printContainer.appendChild(expenseCard);
            printContainer.appendChild(summaryCard);
            document.body.appendChild(printContainer);
            const expenseElements = [printContainer.querySelector('#expense-list-card > h2'), ...printContainer.querySelectorAll('#expenseList > div')].filter(el => el);
            for (const element of expenseElements) { await addElementToPDF(element); }
            if (expenseElements.length > 1) { doc.addPage(); currentY = margin; }
            const individualStatusTitle = Array.from(printContainer.querySelectorAll('#summary-card h3')).find(h => h.textContent.includes('ê°œì¸ë³„ ì •ì‚° í˜„í™©'));
            const settlementMethodTitle = Array.from(printContainer.querySelectorAll('#summary-card h3')).find(h => h.textContent.includes('ì •ì‚° ë°©ë²•'));
            const summaryElements = [printContainer.querySelector('#summary-menu'), printContainer.querySelector('#total-spending'), individualStatusTitle, ...printContainer.querySelectorAll('#summaryList > div'), settlementMethodTitle, ...printContainer.querySelectorAll('#transactionList > div')].filter(el => el);
            for (const element of summaryElements) { await addElementToPDF(element); }
            doc.save(`ì •ì‚°ë‚´ì—­_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (error) {
            console.error("PDF ìƒì„± ì˜¤ë¥˜:", error);
            alert("PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        } finally {
            const containers = document.querySelectorAll('[style*="z-index: -9999"]');
            containers.forEach(container => { if (container.parentNode) container.parentNode.removeChild(container); });
            exportBtn.innerText = originalText;
            exportBtn.disabled = false;
        }
    }

    document.getElementById("personName").addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); addPerson(); } });
    document.getElementById("expenseAmount").addEventListener("input", validateManualAmounts);

  // -------------------------------
// PWA ì„¤ì¹˜ ê´€ë ¨ ì½”ë“œ
// -------------------------------
let deferredPrompt;

// Service Worker ë“±ë¡
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log("âœ… Service Worker ë“±ë¡ ì™„ë£Œ"))
    .catch(err => console.error("Service Worker ë“±ë¡ ì‹¤íŒ¨:", err));
}

// beforeinstallprompt ì´ë²¤íŠ¸ ê°ì§€
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // ìˆ¨ê²¨ë‘” ì„¤ì¹˜ ë²„íŠ¼ê³¼ íŒì—… ë…¸ì¶œ
  if (!localStorage.getItem("hideInstallPopup")) {
    document.getElementById("custom-install-btn").classList.remove("hidden");
    document.getElementById("install-popup-overlay").classList.remove("hidden");
  }
});

// ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById("custom-install-btn").addEventListener("click", async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log("ì‚¬ìš©ì ì„ íƒ:", outcome);
    deferredPrompt = null;
    document.getElementById("install-popup-overlay").classList.add("hidden");
  }
});

// íŒì—… ë‹«ê¸°
document.getElementById("close-popup-btn").addEventListener("click", () => {
  document.getElementById("install-popup-overlay").classList.add("hidden");
});

// ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
document.getElementById("dismiss-popup-btn").addEventListener("click", () => {
  localStorage.setItem("hideInstallPopup", "true");
  document.getElementById("install-popup-overlay").classList.add("hidden");
});


</script>

</body>
</html>
