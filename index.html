<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>정산 계산기</title>

  <link rel="icon" href="/settlement/favicon.ico">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div id="start-screen" class="max-w-4xl mx-auto space-y-6">
    <div class="bg-white p-6 rounded-2xl shadow-md text-center">
      <h1 class="text-2xl font-bold mb-4">🚀 정산 계산기</h1>
      <p class="text-gray-600 mb-6">새로운 정산을 시작하거나 기존 목록을 불러오세요.</p>

      <button id="custom-install-btn" class="hidden w-full px-4 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition mb-3">
        📲 앱으로 설치하기
      </button>

      <button onclick="createNewSettlement()" class="w-full px-4 py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition">
        새로운 정산 작성하기
      </button>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">저장된 정산 목록</h2>
      <div id="saved-settlements-list" class="space-y-3"></div>
    </div>
  </div>

  <div id="main-app" class="max-w-4xl mx-auto space-y-6 hidden">
    <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between">
       <button onclick="showStartScreen()" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-xl hover:bg-gray-300 transition">&lt; 목록으로</button>
       <h1 id="settlement-title" class="text-xl font-bold text-center flex-1">정산</h1>
       <div class="w-24"></div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">참여자 관리</h2>
        <button onclick="resetAllData()" class="px-3 py-1 bg-red-500 text-white text-sm rounded-xl hover:bg-red-600 transition">전체 초기화</button>
      </div>
      <div class="flex gap-2 mb-3">
        <input id="personName" type="text" placeholder="이름 입력"
          class="flex-1 rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
        <button onclick="addPerson()"
          class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition">추가</button>
      </div>
      <div id="personList" class="flex flex-wrap gap-2"></div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">지출 추가</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="expenseTitle" type="text" placeholder="항목" class="rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
        <input id="expenseAmount" type="number" placeholder="금액" class="rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
        <select id="paidBy" class="rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition">
          <option value="">결제자 선택</option>
        </select>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="splitType" value="equal" checked onchange="toggleSplitType()"><span>균등 분할</span></label>
          <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="splitType" value="manual" onchange="toggleSplitType()"><span>수동 입력</span></label>
        </div>
      </div>
      <div id="equalSplitContainer" class="mt-3">
        <span class="font-semibold">정산 대상자:</span>
        <div id="involvedPeopleContainer" class="flex flex-wrap gap-2 mt-2"></div>
      </div>
      <div id="manualSplitContainer" class="mt-3 hidden">
        <span class="font-semibold">개별 정산 금액:</span>
        <div id="manualAmountContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2"></div>
        <div id="amountValidation" class="mt-2 text-sm"></div>
      </div>
      <div class="mt-3">
        <label class="block text-sm font-medium mb-1">비고 (선택사항):</label>
        <input id="expenseNote" type="text" placeholder="비고 입력" class="w-full rounded-xl border px-3 py-2 focus:ring-2 focus:ring-blue-500 transition" />
      </div>
      <button onclick="addExpense()" class="mt-4 px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 w-full transition">지출 추가</button>
    </div>

    <div id="expense-list-card" class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">지출 목록</h2>
      <div id="expenseList" class="space-y-3"></div>
    </div>

    <div id="summary-card" class="bg-white p-6 rounded-2xl shadow-md space-y-6">
      <div id="summary-menu" class="flex justify-between items-center flex-wrap gap-2">
        <h2 class="text-lg font-semibold mb-4">정산 결과 🚀</h2>
        <div class="flex gap-2">
          <select id="roundingOption" onchange="updateSummary()" class="px-3 py-1 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 transition">
            <option value="none">원단위 그대로</option>
            <option value="0">소수점 제거</option>
            <option value="10">1원 단위 반올림</option>
            <option value="100">10원 단위 반올림</option>
          </select>
          <button onclick="exportTXT()" class="px-3 py-1 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-sm transition">TXT</button>
          <button id="pdf-export-btn" onclick="exportPDF()" class="px-3 py-1 bg-purple-500 text-white rounded-xl hover:bg-purple-600 text-sm transition">PDF</button>
          <button onclick="exportImage()" class="px-3 py-1 bg-yellow-500 text-white rounded-xl hover:bg-yellow-600 text-sm transition">IMG</button>
        </div>
      </div>

      <div id="total-spending" class="p-4 bg-gray-100 rounded-xl text-center">
         <p class="text-gray-600">총 지출 금액</p>
         <p id="totalAmount" class="text-2xl font-bold text-gray-800">₩ 0</p>
      </div>

      <div>
        <h3 class="font-bold mb-3 text-lg">💸 개인별 정산 현황</h3>
        <div id="summaryList" class="space-y-2"></div>
      </div>

      <div class="border-t pt-4">
        <h3 class="font-bold mb-3 text-lg">✅ 정산 방법</h3>
        <div id="transactionList" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <div id="install-popup-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 transition-opacity">
    <div id="install-popup-content" class="bg-white rounded-2xl shadow-xl p-6 m-4 max-w-sm w-full text-center transform scale-95 transition-transform">
      <h3 class="text-xl font-bold mb-2">앱처럼 설치해서 사용하세요!</h3>
      <p class="text-gray-600 mb-4">바탕화면에 '정산 계산기'를 추가하고<br>더 빠르고 편리하게 이용할 수 있습니다.</p>
      <div id="install-guide" class="bg-gray-100 p-4 rounded-lg mb-4">
        <div id="install-guide-icon" class="w-12 h-12 mx-auto mb-2 text-blue-500"></div>
        <p id="install-guide-text" class="font-semibold text-gray-700"></p>
      </div>
      <div class="flex flex-col gap-2">
        <button id="close-popup-btn" class="w-full px-4 py-2 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition">이해했습니다</button>
        <button id="dismiss-popup-btn" class="w-full text-sm text-gray-500 hover:text-gray-700">다시 보지 않기</button>
      </div>
    </div>
  </div>

<script>
    // --- 상태 관리 변수 ---
    let people = [];
    let expenses = [];
    let currentSettlementId = null;

    // --- 데이터 관리 및 앱 핵심 기능 함수들 ---
    function getSettlements() {
      return JSON.parse(localStorage.getItem('settlements') || '[]');
    }

    function saveSettlements(settlements) {
      localStorage.setItem('settlements', JSON.stringify(settlements));
    }

    function saveCurrentSettlement() {
        if (!currentSettlementId) return;
        const settlements = getSettlements();
        const index = settlements.findIndex(s => s.id === currentSettlementId);
        if (index > -1) {
            settlements[index].people = people;
            settlements[index].expenses = expenses;
            saveSettlements(settlements);
        }
    }

    function showStartScreen() {
        document.getElementById('start-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
        renderSavedSettlements();
        currentSettlementId = null;
    }

    function showMainApp() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
    }

    function renderSavedSettlements() {
        const settlements = getSettlements();
        const container = document.getElementById('saved-settlements-list');
        container.innerHTML = '';
        if (settlements.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500">저장된 내역이 없습니다.</p>`;
            return;
        }
        settlements.sort((a, b) => b.id - a.id);
        settlements.forEach(s => {
            const date = new Date(s.id).toLocaleDateString('ko-KR');
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-xl';
            div.innerHTML = `
                <div>
                    <p class="font-semibold">${s.name}</p>
                    <p class="text-sm text-gray-500">생성일: ${date}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadSettlement(${s.id})" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-xl hover:bg-blue-600 transition">불러오기</button>
                    <button onclick="deleteSettlement(${s.id})" class="px-3 py-1 bg-red-500 text-white text-sm rounded-xl hover:bg-red-600 transition">삭제</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function createNewSettlement() {
        const name = prompt("새로운 정산의 이름을 입력해주세요:", `정산 ${new Date().toLocaleDateString()}`);
        if (!name || !name.trim()) return;
        const settlements = getSettlements();
        const newSettlement = {
            id: Date.now(),
            name: name.trim(),
            people: [],
            expenses: []
        };
        settlements.push(newSettlement);
        saveSettlements(settlements);
        loadSettlement(newSettlement.id);
    }

    function loadSettlement(id) {
        const settlements = getSettlements();
        const settlement = settlements.find(s => s.id === id);
        if (settlement) {
            currentSettlementId = settlement.id;
            people = settlement.people || [];
            expenses = settlement.expenses || [];
            document.getElementById('settlement-title').innerText = settlement.name;
            showMainApp();
            renderAll();
        }
    }

    function deleteSettlement(id) {
        if (!confirm("정말로 이 정산 내역을 삭제하시겠습니까?")) return;
        let settlements = getSettlements();
        settlements = settlements.filter(s => s.id !== id);
        saveSettlements(settlements);
        renderSavedSettlements();
    }

    function initializeApp() {
        showStartScreen();
    }

    function renderAll() {
        renderPeople();
        renderExpenses();
        updateSummary();
    }

    function resetAllData() {
        if(confirm('정말로 모든 참여자와 지출 내역을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            people = [];
            expenses = [];
            saveCurrentSettlement();
            renderAll();
        }
    }

    function renderPeople() {
        const personList = document.getElementById("personList");
        const paidBy = document.getElementById("paidBy");
        const involvedContainer = document.getElementById("involvedPeopleContainer");
        const manualContainer = document.getElementById("manualAmountContainer");
        personList.innerHTML = "";
        paidBy.innerHTML = '<option value="">결제자 선택</option>';
        involvedContainer.innerHTML = "";
        manualContainer.innerHTML = "";
        people.forEach((person, index) => {
            const badge = document.createElement("div");
            badge.className = "flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full";
            badge.innerHTML = `<span>${person}</span><button onclick="removePerson(${index})" class="text-red-500 hover:text-red-700 font-bold">x</button>`;
            personList.appendChild(badge);
            const opt1 = new Option(person, person);
            paidBy.add(opt1);
            const checkbox = document.createElement("label");
            checkbox.className = "flex items-center gap-2 px-3 py-1 bg-gray-200 rounded-xl cursor-pointer text-gray-700";
            checkbox.innerHTML = `<input type="checkbox" class="involved-checkbox" value="${person}" checked> ${person}`;
            involvedContainer.appendChild(checkbox);
            const manualInput = document.createElement("div");
            manualInput.className = "flex items-center gap-2";
            manualInput.innerHTML = `<label class="w-20 text-sm font-medium">${person}:</label><input type="number" class="manual-amount flex-1 rounded-xl border px-2 py-1" data-person="${person}" placeholder="0" oninput="recalculateManualAmounts(this)"><span class="text-xs text-gray-500">원</span>`;
            manualContainer.appendChild(manualInput);
        });
    }

    function addPerson() {
      const input = document.getElementById("personName");
      const name = input.value.trim();
      if (!name) return;
      if (people.includes(name)) {
        alert("이미 존재하는 이름입니다.");
        return;
      }
      people.push(name);
      input.value = "";
      renderPeople();
      updateSummary();
      saveCurrentSettlement();
    }

    function removePerson(index) {
      people.splice(index, 1);
      renderPeople();
      updateSummary();
      saveCurrentSettlement();
    }
    function autoFillManualAmounts() {
        const totalAmount = parseFloat(document.getElementById("expenseAmount").value) || 0;
        const manualInputs = document.querySelectorAll(".manual-amount");
        const numPeople = manualInputs.length;

        if (totalAmount > 0 && numPeople > 0) {
            const baseAmount = Math.floor(totalAmount / numPeople);
            const remainder = totalAmount % numPeople;

            manualInputs.forEach((input, index) => {
                let personAmount = baseAmount;
                // 마지막 사람에게 나머지 금액을 더해줍니다.
                if (index === numPeople - 1) {
                    personAmount += remainder;
                }
                input.value = personAmount;
            });
        } else {
            manualInputs.forEach(input => {
                input.value = "";
            });
        }
        validateManualAmounts(); // 금액이 자동 분배된 후 유효성 검사를 다시 실행합니다.
    }

    // 사용자가 수동 금액을 수정할 때마다 나머지 금액을 재분배하는 함수
    function recalculateManualAmounts(editedInput) {
        // 수정된 입력 필드에 '수정됨' 상태를 표시합니다.
        if (editedInput) {
            editedInput.setAttribute('data-edited', 'true');
        }

        const totalAmount = parseFloat(document.getElementById("expenseAmount").value) || 0;
        const manualInputs = Array.from(document.querySelectorAll(".manual-amount"));

        let fixedAmount = 0;
        const uneditedInputs = [];

        // 수정된 값(고정액)과 수정되지 않은 입력 필드를 분리합니다.
        manualInputs.forEach(input => {
            if (input.getAttribute('data-edited') === 'true') {
                fixedAmount += parseFloat(input.value) || 0;
            } else {
                uneditedInputs.push(input);
            }
        });

        const remainingAmount = totalAmount - fixedAmount;
        const numUnedited = uneditedInputs.length;

        // 수정되지 않은 필드에 나머지 금액을 1/n로 분배합니다.
        if (numUnedited > 0) {
            const baseAmount = Math.floor(remainingAmount / numUnedited);
            const remainder = remainingAmount % numUnedited;

            uneditedInputs.forEach((input, index) => {
                let personAmount = baseAmount;
                if (index === numUnedited - 1) { // 마지막 사람에게 나머지 할당
                    personAmount += remainder;
                }
                input.value = personAmount;
            });
        }

        validateManualAmounts(); // 최종적으로 금액 합계 유효성 검사
    }


    function toggleSplitType() {
        const isManual = document.querySelector('input[name="splitType"]:checked').value === 'manual';
        document.getElementById('equalSplitContainer').classList.toggle('hidden', isManual);
        document.getElementById('manualSplitContainer').classList.toggle('hidden', !isManual);

        if (isManual) {
            // 모든 입력 필드의 '수정됨' 상태를 초기화합니다.
            document.querySelectorAll(".manual-amount").forEach(input => {
                input.removeAttribute('data-edited');
            });
            // 재계산 함수를 호출하여 1/n을 먼저 채웁니다. (인자 없이 호출)
            recalculateManualAmounts();
        }
    }

    function validateManualAmounts() {
      const totalAmount = parseFloat(document.getElementById("expenseAmount").value) || 0;
      let manualTotal = 0;
      document.querySelectorAll(".manual-amount").forEach(input => {
        manualTotal += parseFloat(input.value) || 0;
      });
      const validationDiv = document.getElementById("amountValidation");
      const difference = totalAmount - manualTotal;
      if (Math.abs(difference) < 0.01) {
        validationDiv.innerHTML = '<span class="text-green-600">✓ 금액이 일치합니다</span>';
      } else if (difference > 0) {
        validationDiv.innerHTML = `<span class="text-orange-600">⚠ ${difference.toLocaleString()}원 부족합니다</span>`;
      } else {
        validationDiv.innerHTML = `<span class="text-red-600">✗ ${Math.abs(difference).toLocaleString()}원 초과입니다</span>`;
      }
    }

    function addExpense() {
      const title = document.getElementById("expenseTitle").value.trim();
      const amount = parseFloat(document.getElementById("expenseAmount").value);
      const paidBy = document.getElementById("paidBy").value;
      const splitType = document.querySelector('input[name="splitType"]:checked').value;
      if (!title || isNaN(amount) || amount <= 0 || !paidBy) {
        alert("항목, 0원 초과의 금액, 결제자를 모두 입력해주세요.");
        return;
      }
      const expenseData = { title, amount, paidBy, splitType };
      if (splitType === 'equal') {
        const involved = Array.from(document.querySelectorAll(".involved-checkbox:checked")).map(cb => cb.value);
        if (involved.length === 0) {
          alert("정산 대상자를 선택해주세요.");
          return;
        }
        expenseData.involved = involved;
      } else {
        const manualAmounts = {};
        let manualTotal = 0;
        document.querySelectorAll(".manual-amount").forEach(input => {
          const personAmount = parseFloat(input.value) || 0;
          if (personAmount > 0) {
            manualAmounts[input.dataset.person] = personAmount;
            manualTotal += personAmount;
          }
        });
        if (Math.abs(amount - manualTotal) > 0.01) {
          alert("수동 입력 금액의 합이 총 금액과 일치하지 않습니다.");
          return;
        }
        if (Object.keys(manualAmounts).length === 0) {
          alert("최소 한 명의 정산 금액을 입력해주세요.");
          return;
        }
        expenseData.manualAmounts = manualAmounts;
      }
      const note = document.getElementById("expenseNote").value.trim();
      if (note) expenseData.note = note;
      expenses.push(expenseData);
      document.getElementById("expenseTitle").value = "";
      document.getElementById("expenseAmount").value = "";
      document.getElementById("paidBy").value = "";
      document.querySelectorAll(".involved-checkbox").forEach(cb => cb.checked = true);
      document.querySelectorAll(".manual-amount").forEach(input => input.value = "");
      document.getElementById("expenseNote").value = "";
      document.getElementById("amountValidation").innerHTML = "";
      renderExpenses();
      updateSummary();
      saveCurrentSettlement();
    }

    function renderExpenses() {
        const container = document.getElementById("expenseList");
        container.innerHTML = "";
        if (expenses.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500">추가된 지출 내역이 없습니다.</p>`;
            return;
        }
        expenses.forEach((exp, index) => {
            const colors = ["bg-purple-50 border-purple-200", "bg-green-50 border-green-200", "bg-yellow-50 border-yellow-200", "bg-pink-50 border-pink-200", "bg-blue-50 border-blue-200"];
            const div = document.createElement("div");
            div.className = `p-4 rounded-2xl border-2 flex justify-between items-start ${colors[index % colors.length]}`;

            let splitInfo = "";
            if (exp.splitType === 'equal') {
                // 균등 정산 시, 각 참여자의 부담액을 계산하여 표시합니다.
                const amountPerPerson = Math.round(exp.amount / exp.involved.length);
                splitInfo = exp.involved.map(person => `<i class="font-semibold">${person}</i> ${amountPerPerson.toLocaleString()}원`).join(", ");

            } else {
                // 수동 정산 시, 각 참여자 이름에 이탤릭체를 적용합니다.
                splitInfo = Object.entries(exp.manualAmounts).map(([person, amount]) => `<i class="font-semibold">${person}</i> ${amount.toLocaleString()}원`).join(", ");
            }

            if (exp.note) {
                splitInfo += `<br><span class="text-xs text-gray-500 mt-1 inline-block">비고: ${exp.note}</span>`;
            }

            const splitTypeLabel = exp.splitType === 'equal' ? '균등' : '수동';
            const splitTypeBadgeColor = exp.splitType === 'equal' ? 'bg-blue-500' : 'bg-green-500';

            div.innerHTML = `
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-0.5 text-xs font-semibold text-white rounded-full ${splitTypeBadgeColor}">${splitTypeLabel}</span>
              <span class="font-semibold">${exp.title} - ${exp.amount.toLocaleString()}원 (결제: ${exp.paidBy})</span>
            </div>
            <div class="text-sm text-gray-600 pl-1">${splitInfo}</div>
          </div>
          <button onclick="removeExpense(${index})" class="px-3 py-1 bg-red-500 text-white rounded-xl hover:bg-red-600 ml-3 transition">삭제</button>
        `;
            container.appendChild(div);
        });
    }

    function removeExpense(index) {
      expenses.splice(index, 1);
      renderExpenses();
      updateSummary();
      saveCurrentSettlement();
    }

    function updateSummary() {
      const balances = getBalances();
      const summaryList = document.getElementById("summaryList");
      summaryList.innerHTML = "";
      if (people.length === 0) {
        summaryList.innerHTML = `<p class="text-center text-gray-500 font-medium text-base">참여자를 추가해주세요.</p>`;
        document.getElementById('totalAmount').innerText = '₩ 0';
        document.getElementById('transactionList').innerHTML = '';
        return;
      }
      const totalSpending = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      document.getElementById('totalAmount').innerText = `₩ ${totalSpending.toLocaleString()}`;
      people.forEach(person => {
        const li = document.createElement("div");
        li.className = "flex justify-between items-center p-3 rounded-xl";
        const amount = balances[person] || 0;
        let amountText;
        if (amount > 0.01) {
            li.className += ' bg-blue-50';
            amountText = `<span class="font-bold text-blue-700">+${amount.toLocaleString()}원</span>`;
        } else if (amount < -0.01) {
            li.className += ' bg-red-50';
            amountText = `<span class="font-bold text-red-700">${amount.toLocaleString()}원</span>`;
        } else {
            li.className += ' bg-gray-100';
            amountText = `<span class="font-bold text-gray-700">${amount.toLocaleString()}원</span>`;
        }
        li.innerHTML = `<span class="font-medium">${person}</span> ${amountText}`;
        summaryList.appendChild(li);
      });
      renderTransactions(balances);
    }

    function renderTransactions(balances) {
        const transactionList = document.getElementById("transactionList");
        transactionList.innerHTML = '';
        const transactions = calculateTransactions(balances);
        if (transactions.length === 0) {
            transactionList.innerHTML = `<p class="text-center text-green-600 font-semibold p-4 bg-green-50 rounded-xl">모든 정산이 완료되었습니다! 🎉</p>`;
            return;
        }
        transactions.forEach(({ from, to, amount }) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-xl';
            div.innerHTML = `<span class="font-bold text-red-600">${from}</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg><span class="font-bold text-green-600">${to}</span><span class="font-semibold text-gray-800 bg-gray-200 px-3 py-1 rounded-full">${amount.toLocaleString()}원</span>`;
            transactionList.appendChild(div);
        });
    }

    function calculateTransactions(balances) {
        const creditors = [];
        const debtors = [];
        Object.entries(balances).forEach(([person, amount]) => {
            if (amount > 0.01) creditors.push({ person, amount });
            else if (amount < -0.01) debtors.push({ person, amount: -amount });
        });
        creditors.sort((a, b) => b.amount - a.amount);
        debtors.sort((a, b) => b.amount - a.amount);
        const transactions = [];
        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
            const debtor = debtors[i];
            const creditor = creditors[j];
            const amountToTransfer = Math.min(debtor.amount, creditor.amount);
            if (amountToTransfer > 0.01) {
              transactions.push({ from: debtor.person, to: creditor.person, amount: Math.round(amountToTransfer) });
            }
            debtor.amount -= amountToTransfer;
            creditor.amount -= amountToTransfer;
            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }
        return transactions;
    }

    function getBalances() {
      const balances = {};
      people.forEach(p => balances[p] = 0);
      expenses.forEach(exp => {
        if (people.includes(exp.paidBy)) balances[exp.paidBy] += exp.amount;
        if (exp.splitType === 'equal') {
          const share = exp.amount / exp.involved.length;
          exp.involved.forEach(p => { if (people.includes(p)) balances[p] -= share; });
        } else {
          Object.entries(exp.manualAmounts).forEach(([p, a]) => { if (people.includes(p)) balances[p] -= a; });
        }
      });
      const roundingOption = document.getElementById("roundingOption").value;
      Object.keys(balances).forEach(person => {
        const amount = balances[person];
        if (roundingOption === "0") balances[person] = Math.round(amount);
        else if (roundingOption === "10") balances[person] = Math.round(amount / 10) * 10;
        else if (roundingOption === "100") balances[person] = Math.round(amount / 100) * 100;
        else balances[person] = Math.round(amount * 100) / 100;
      });
      return balances;
    }

    function generateContent() {
      const balances = getBalances();
      const transactions = calculateTransactions(balances);
      const totalSpending = expenses.reduce((sum, exp) => sum + exp.amount, 0);
      const now = new Date();
      let content = [ `정산 내역 (${now.toLocaleDateString('ko-KR')})`, '='.repeat(50), `👥 참여자: ${people.join(', ')}`, `💰 총 지출: ${totalSpending.toLocaleString()}원`, '', '--- 📝 지출 목록 ---' ];
      expenses.forEach((exp, index) => {
        content.push(`${index + 1}. ${exp.title} - ${exp.amount.toLocaleString()}원 (결제: ${exp.paidBy})`);
        if (exp.splitType === 'equal') {
          const share = exp.amount / exp.involved.length;
          content.push(`  - 방식: 균등분할 (${exp.involved.join(', ')})`, `  - 인당: ${Math.round(share).toLocaleString()}원`);
        } else {
          content.push(`  - 방식: 수동분할`);
          Object.entries(exp.manualAmounts).forEach(([p, a]) => content.push(`    - ${p}: ${a.toLocaleString()}원`));
          if (exp.note) content.push(`  - 비고: ${exp.note}`);
        }
        content.push('');
      });
      content.push('--- 💸 개인별 정산 현황 ---');
      people.forEach(person => {
        const amount = balances[person] || 0;
        const status = amount > 0.01 ? '받을 금액' : amount < -0.01 ? '보낼 금액' : '정산완료';
        content.push(`${person}: ${amount > 0 ? '+' : ''}${amount.toLocaleString()}원 (${status})`);
      });
      content.push('\n--- ✅ 정산 방법 ---');
      if (transactions.length === 0) {
        content.push('모든 정산이 완료되었습니다!');
      } else {
        transactions.forEach(t => { content.push(`${t.from} → ${t.to} : ${t.amount.toLocaleString()}원`); });
      }
      return content.join('\n');
    }

    function exportTXT() {
      const content = generateContent();
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `정산내역_${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function exportPDF() {
        const exportBtn = document.getElementById('pdf-export-btn');
        const originalText = exportBtn.innerText;
        exportBtn.innerText = '생성 중..';
        exportBtn.disabled = true;
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const margin = 15;
            const pdfWidth = doc.internal.pageSize.getWidth() - margin * 2;
            const pageHeight = doc.internal.pageSize.getHeight();
            let currentY = margin;
            const checkPageBreak = (requiredHeight) => { if (currentY + requiredHeight > pageHeight - margin - 10) { doc.addPage(); currentY = margin; return true; } return false; };
            const addElementToPDF = async (element) => {
                if (!element || element.offsetHeight === 0) return;
                const canvas = await html2canvas(element, { scale: 1.5, useCORS: true, backgroundColor: '#ffffff', logging: false });
                const imgData = canvas.toDataURL('image/png');
                const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                const maxHeight = pageHeight - margin * 2;
                if (imgHeight > maxHeight) {
                    const totalParts = Math.ceil(imgHeight / maxHeight);
                    const partHeight = maxHeight;
                    const canvasPartHeight = canvas.height / totalParts;
                    for (let i = 0; i < totalParts; i++) {
                        if (i > 0) { doc.addPage(); currentY = margin; } else { checkPageBreak(partHeight); }
                        const partCanvas = document.createElement('canvas');
                        const partCtx = partCanvas.getContext('2d');
                        partCanvas.width = canvas.width;
                        partCanvas.height = canvasPartHeight;
                        partCtx.drawImage(canvas, 0, i * canvasPartHeight, canvas.width, canvasPartHeight, 0, 0, canvas.width, canvasPartHeight);
                        const partImgData = partCanvas.toDataURL('image/png');
                        doc.addImage(partImgData, 'PNG', margin, currentY, pdfWidth, partHeight);
                        currentY += partHeight + 3;
                    }
                } else {
                    checkPageBreak(imgHeight);
                    doc.addImage(imgData, 'PNG', margin, currentY, pdfWidth, imgHeight);
                    currentY += imgHeight + 5;
                }
            };
            const printContainer = document.createElement('div');
            printContainer.style.cssText = `position: fixed; top: 0; left: 0; width: 750px; background: white; padding: 20px; z-index: -9999; opacity: 0;`;
            const expenseCard = document.getElementById('expense-list-card').cloneNode(true);
            const summaryCard = document.getElementById('summary-card').cloneNode(true);
            summaryCard.querySelectorAll('button, select').forEach(btn => btn.remove());
            printContainer.appendChild(expenseCard);
            printContainer.appendChild(summaryCard);
            document.body.appendChild(printContainer);
            const expenseElements = [printContainer.querySelector('#expense-list-card > h2'), ...printContainer.querySelectorAll('#expenseList > div')].filter(el => el);
            for (const element of expenseElements) { await addElementToPDF(element); }
            if (expenseElements.length > 1) { doc.addPage(); currentY = margin; }
            const individualStatusTitle = Array.from(printContainer.querySelectorAll('#summary-card h3')).find(h => h.textContent.includes('개인별 정산 현황'));
            const settlementMethodTitle = Array.from(printContainer.querySelectorAll('#summary-card h3')).find(h => h.textContent.includes('정산 방법'));
            const summaryElements = [printContainer.querySelector('#summary-menu'), printContainer.querySelector('#total-spending'), individualStatusTitle, ...printContainer.querySelectorAll('#summaryList > div'), settlementMethodTitle, ...printContainer.querySelectorAll('#transactionList > div')].filter(el => el);
            for (const element of summaryElements) { await addElementToPDF(element); }
            doc.save(`정산내역_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (error) {
            console.error("PDF 생성 오류:", error);
            alert("PDF 생성 중 오류가 발생했습니다. 다시 시도해주세요.");
        } finally {
            const containers = document.querySelectorAll('[style*="z-index: -9999"]');
            containers.forEach(container => { if (container.parentNode) container.parentNode.removeChild(container); });
            exportBtn.innerText = originalText;
            exportBtn.disabled = false;
        }
    }

    // 👇 여기에 새로운 함수를 추가하세요!
    async function exportImage() {
        const settleTitle = document.getElementById('settlement-title').innerText || '정산';
        const now = new Date();
        const dateString = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;

        const balances = getBalances();
        const transactions = calculateTransactions(balances);

        // 1. 이미지를 생성하기 위한 임시 컨테이너를 만듭니다.
        const container = document.createElement('div');

        // [수정된 부분] opacity: 0 대신 left: -9999px 로 요소를 화면 밖으로 이동시킵니다.
        container.style.cssText = `position: absolute; top: 0; left: -9999px; width: 600px; background-color: #f9fafb; padding: 30px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;`;

        let finalSettlementHtml = '';
        if (transactions.length === 0) {
            finalSettlementHtml = `<div style="text-align: center; color: #16a34a; font-weight: 600; padding: 1rem; background-color: #f0fdf4; border-radius: 0.75rem;">모든 정산이 완료되었습니다! 🎉</div>`;
        } else {
            transactions.forEach(({ from, to, amount }) => {
                finalSettlementHtml += `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background-color: #f9fafb; border-radius: 0.75rem; margin-bottom: 0.75rem;">
              <span style="font-weight: 700; color: #dc2626;">${from}</span>
              <svg xmlns="http://www.w3.org/2000/svg" style="height: 1.25rem; width: 1.25rem; color: #6b7280; flex-shrink: 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
              <span style="font-weight: 700; color: #16a34a;">${to}</span>
              <span style="font-weight: 600; color: #1f2937; background-color: #e5e7eb; padding: 0.25rem 0.75rem; border-radius: 9999px; white-space: nowrap;">${amount.toLocaleString()}원</span>
            </div>
          `;
            });
        }

        let htmlContent = `
        <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 25px;">
          <h1 style="text-align: center; font-size: 24px; font-weight: 800; margin-bottom: 8px;">${settleTitle} 내역서</h1>
          <p style="text-align: center; font-size: 14px; color: #6b7280; margin-bottom: 25px;">${dateString} 기준</p>

          <div style="border-top: 2px dashed #e5e7eb; padding-top: 20px;">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">📈 지출 요약</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; background: #f3f4f6; padding: 15px; border-radius: 8px;">
              <span style="font-size: 16px; color: #4b5563;">총 지출 금액</span>
              <span style="font-size: 20px; font-weight: 700; white-space: nowrap;">${document.getElementById('totalAmount').innerText}</span>
            </div>
            <div style="margin-top: 10px;">
              <span style="font-size: 16px; color: #4b5563;">참여자 (${people.length}명)</span>
              <p style="font-size: 16px; font-weight: 500; margin-top: 5px; color: #1f2937;">${people.join(', ')}</p>
            </div>
          </div>

          <div style="border-top: 2px dashed #e5e7eb; padding-top: 20px; margin-top: 25px;">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 15px;">📋 상세 지출 내역</h2>
            <div style="font-size: 15px; line-height: 1.8;">`;

        expenses.forEach(exp => {
            htmlContent += `<div style="padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                        <div style="display: flex; justify-content: space-between; font-weight: 600;">
                          <span>${exp.title}</span>
                          <span style="white-space: nowrap; padding-left: 10px;">${exp.amount.toLocaleString()}원</span>
                        </div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">결제: ${exp.paidBy}</div>
                      </div>`;
        });

        htmlContent += `</div></div>
          <div style="border-top: 2px dashed #e5e7eb; padding-top: 20px; margin-top: 25px;">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 15px;">✅ 최종 정산</h2>
            ${finalSettlementHtml}
          </div>
        </div>
      `;

        container.innerHTML = htmlContent;
        document.body.appendChild(container);

        // 2. html2canvas를 사용하여 컨테이너를 이미지로 변환합니다.
        try {
            const canvas = await html2canvas(container, {
                scale: 2,
                useCORS: true // CORS 문제 방지를 위해 옵션 추가
            });
            const a = document.createElement('a');
            a.href = canvas.toDataURL('image/jpeg', 0.95);
            a.download = `${settleTitle}_정산내역.jpg`;
            a.click();
        } catch (error) {
            console.error("이미지 생성 오류:", error);
            alert("이미지 생성 중 오류가 발생했습니다.");
        } finally {
            // 3. 임시 컨테이너를 제거합니다.
            document.body.removeChild(container);
        }
    }

    document.getElementById("personName").addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); addPerson(); } });
    document.getElementById("expenseAmount").addEventListener("input", () => {
        const isManual = document.querySelector('input[name="splitType"]:checked').value === 'manual';
        if (isManual) {
            // 금액이 바뀌면 처음부터 다시 계산해야 하므로 '수정됨' 상태를 모두 제거합니다.
            document.querySelectorAll(".manual-amount").forEach(input => {
                input.removeAttribute('data-edited');
            });
            recalculateManualAmounts(); // 재계산 함수 호출
        } else {
            validateManualAmounts();
        }
    });

   initializeApp();
  // -------------------------------
// PWA 설치 관련 코드
// -------------------------------
let deferredPrompt;

// Service Worker 등록
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(() => console.log("✅ Service Worker 등록 완료"))
    .catch(err => console.error("Service Worker 등록 실패:", err));
}

// beforeinstallprompt 이벤트 감지
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // 숨겨둔 설치 버튼과 팝업 노출
  if (!localStorage.getItem("hideInstallPopup")) {
    document.getElementById("custom-install-btn").classList.remove("hidden");
    document.getElementById("install-popup-overlay").classList.remove("hidden");
  }
});

// 설치 버튼 클릭 시
document.getElementById("custom-install-btn").addEventListener("click", async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log("사용자 선택:", outcome);
    deferredPrompt = null;
    document.getElementById("install-popup-overlay").classList.add("hidden");
  }
});

// 팝업 닫기
document.getElementById("close-popup-btn").addEventListener("click", () => {
  document.getElementById("install-popup-overlay").classList.add("hidden");
});

// 다시 보지 않기
document.getElementById("dismiss-popup-btn").addEventListener("click", () => {
  localStorage.setItem("hideInstallPopup", "true");
  document.getElementById("install-popup-overlay").classList.add("hidden");
});


</script>

</body>
</html>
